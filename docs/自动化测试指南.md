# SmartFA 自动化测试指南

## 1. 自动化测试概述

### 1.1 自动化测试目标
- 提高测试效率，减少重复性工作
- 保证测试的一致性和可重复性
- 支持持续集成和持续部署
- 快速反馈代码质量
- 降低回归测试成本

### 1.2 自动化测试策略
- **单元测试**：代码级别，快速反馈
- **集成测试**：服务级别，验证协作
- **端到端测试**：用户级别，验证流程
- **性能测试**：系统级别，验证性能
- **安全测试**：安全级别，验证漏洞

### 1.3 自动化测试框架
```
SmartFA
├── backend/                    # 后端自动化测试
│   ├── unit-tests/            # 单元测试
│   ├── integration-tests/     # 集成测试
│   └── api-tests/             # API测试
├── frontend/                   # 前端自动化测试
│   ├── unit-tests/            # 组件单元测试
│   ├── integration-tests/     # 组件集成测试
│   └── e2e-tests/             # 端到端测试
├── ai-services/                # AI服务自动化测试
│   ├── unit-tests/            # 单元测试
│   └── service-tests/         # 服务测试
├── performance/                # 性能测试
├── security/                   # 安全测试
└── reports/                    # 测试报告
```

## 2. 后端自动化测试

### 2.1 单元测试框架配置

#### 2.1.1 Maven依赖配置
```xml
<!-- pom.xml -->
<dependencies>
    <!-- JUnit 5 -->
    <dependency>
        <groupId>org.junit.jupiter</groupId>
        <artifactId>junit-jupiter</artifactId>
        <version>5.9.3</version>
        <scope>test</scope>
    </dependency>
    
    <!-- Mockito -->
    <dependency>
        <groupId>org.mockito</groupId>
        <artifactId>mockito-core</artifactId>
        <version>5.4.0</version>
        <scope>test</scope>
    </dependency>
    
    <!-- Spring Boot Test -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-test</artifactId>
        <scope>test</scope>
    </dependency>
    
    <!-- TestContainers -->
    <dependency>
        <groupId>org.testcontainers</groupId>
        <artifactId>junit-jupiter</artifactId>
        <scope>test</scope>
    </dependency>
</dependencies>
```

#### 2.1.2 测试配置类
```java
// TestConfig.java
@TestConfiguration
public class TestConfig {
    
    @Bean
    @Primary
    public UserMapper userMapper() {
        return Mockito.mock(UserMapper.class);
    }
    
    @Bean
    @Primary
    public FailureCaseMapper failureCaseMapper() {
        return Mockito.mock(FailureCaseMapper.class);
    }
}
```

### 2.2 单元测试示例

#### 2.2.1 Service层测试
```java
// UserServiceTest.java
@ExtendWith(MockitoExtension.class)
class UserServiceTest {
    
    @Mock
    private UserMapper userMapper;
    
    @InjectMocks
    private UserServiceImpl userService;
    
    @Test
    @DisplayName("用户登录成功测试")
    void testLogin_Success() {
        // Given
        String username = "testuser";
        String password = "password123";
        User mockUser = createMockUser(username, password);
        
        when(userMapper.findByUsername(username)).thenReturn(mockUser);
        
        // When
        Result<String> result = userService.login(username, password);
        
        // Then
        assertTrue(result.isSuccess());
        assertNotNull(result.getData());
        verify(userMapper, times(1)).findByUsername(username);
    }
    
    @Test
    @DisplayName("用户登录失败 - 用户不存在")
    void testLogin_UserNotFound() {
        // Given
        String username = "nonexistent";
        String password = "password123";
        
        when(userMapper.findByUsername(username)).thenReturn(null);
        
        // When
        Result<String> result = userService.login(username, password);
        
        // Then
        assertFalse(result.isSuccess());
        assertEquals(ResultCode.USER_NOT_FOUND, result.getCode());
        verify(userMapper, times(1)).findByUsername(username);
    }
    
    @ParameterizedTest
    @ValueSource(strings = {"", " ", "ab", "a".repeat(51)})
    @DisplayName("用户名验证测试")
    void testUsernameValidation(String username) {
        // Given
        User user = new User();
        user.setUsername(username);
        
        // When & Then
        assertThrows(ValidationException.class, () -> {
            userService.validateUser(user);
        });
    }
    
    private User createMockUser(String username, String password) {
        User user = new User();
        user.setId(1L);
        user.setUsername(username);
        user.setPassword(PasswordUtil.encode(password));
        user.setRealName("测试用户");
        user.setEmail("test@example.com");
        user.setStatus(1);
        user.setCreateTime(LocalDateTime.now());
        user.setUpdateTime(LocalDateTime.now());
        return user;
    }
}
```

#### 2.2.2 Controller层测试
```java
// UserControllerTest.java
@WebMvcTest(UserController.class)
class UserControllerTest {
    
    @Autowired
    private MockMvc mockMvc;
    
    @MockBean
    private UserService userService;
    
    @Autowired
    private ObjectMapper objectMapper;
    
    @Test
    @WithMockUser(roles = {"ADMIN"})
    @DisplayName("获取用户列表成功")
    void testGetUsers_Success() throws Exception {
        // Given
        List<User> users = Arrays.asList(createMockUser());
        when(userService.getUserPage(anyInt(), anyInt(), anyString()))
            .thenReturn(new Page<>(1, 10, 1).setRecords(users));
        
        // When & Then
        mockMvc.perform(get("/api/users")
                .param("page", "1")
                .param("size", "10")
                .contentType(MediaType.APPLICATION_JSON))
                .andExpect(status().isOk())
                .andExpect(jsonPath("$.code").value(200))
                .andExpect(jsonPath("$.data.records").isArray())
                .andExpect(jsonPath("$.data.records[0].username").value("testuser"));
    }
    
    @Test
    @DisplayName("未授权访问用户列表")
    void testGetUsers_Unauthorized() throws Exception {
        // When & Then
        mockMvc.perform(get("/api/users")
                .contentType(MediaType.APPLICATION_JSON))
                .andExpect(status().isUnauthorized());
    }
}
```

### 2.3 集成测试示例

#### 2.3.1 数据库集成测试
```java
// UserRepositoryTest.java
@SpringBootTest
@Testcontainers
@Transactional
class UserRepositoryTest {
    
    @Container
    static MySQLContainer<?> mysql = new MySQLContainer<>("mysql:8.0")
            .withDatabaseName("smartfa_test")
            .withUsername("test")
            .withPassword("test");
    
    @Autowired
    private UserMapper userMapper;
    
    @DynamicPropertySource
    static void configureProperties(DynamicPropertyRegistry registry) {
        registry.add("spring.datasource.url", mysql::getJdbcUrl);
        registry.add("spring.datasource.username", mysql::getUsername);
        registry.add("spring.datasource.password", mysql::getPassword);
    }
    
    @Test
    @DisplayName("数据库CRUD操作测试")
    void testDatabaseOperations() {
        // Create
        User user = new User();
        user.setUsername("testuser");
        user.setPassword("password");
        user.setRealName("测试用户");
        user.setEmail("test@example.com");
        
        int insertResult = userMapper.insert(user);
        assertEquals(1, insertResult);
        assertNotNull(user.getId());
        
        // Read
        User foundUser = userMapper.selectById(user.getId());
        assertNotNull(foundUser);
        assertEquals("testuser", foundUser.getUsername());
        
        // Update
        foundUser.setRealName("更新用户");
        int updateResult = userMapper.updateById(foundUser);
        assertEquals(1, updateResult);
        
        // Delete
        int deleteResult = userMapper.deleteById(user.getId());
        assertEquals(1, deleteResult);
        
        User deletedUser = userMapper.selectById(user.getId());
        assertNull(deletedUser);
    }
}
```

#### 2.3.2 Redis集成测试
```java
// RedisIntegrationTest.java
@SpringBootTest
@Testcontainers
class RedisIntegrationTest {
    
    @Container
    static GenericContainer<?> redis = new GenericContainer<>("redis:7-alpine")
            .withExposedPorts(6379);
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    @DynamicPropertySource
    static void configureProperties(DynamicPropertyRegistry registry) {
        registry.add("spring.redis.host", redis::getHost);
        registry.add("spring.redis.port", () -> redis.getMappedPort(6379).toString());
    }
    
    @Test
    @DisplayName("Redis缓存操作测试")
    void testRedisOperations() {
        String key = "test:key";
        String value = "test_value";
        
        // Set
        redisTemplate.opsForValue().set(key, value);
        
        // Get
        String retrievedValue = (String) redisTemplate.opsForValue().get(key);
        assertEquals(value, retrievedValue);
        
        // Delete
        Boolean deleteResult = redisTemplate.delete(key);
        assertTrue(deleteResult);
        
        String deletedValue = (String) redisTemplate.opsForValue().get(key);
        assertNull(deletedValue);
    }
}
```

### 2.4 API自动化测试

#### 2.4.1 REST API测试框架
```java
// ApiTestBase.java
@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)
@TestMethodOrder(OrderAnnotation.class)
abstract class ApiTestBase {
    
    @Autowired
    protected TestRestTemplate restTemplate;
    
    @LocalServerPort
    protected int port;
    
    protected String getBaseUrl() {
        return "http://localhost:" + port + "/api";
    }
    
    protected <T> ResponseEntity<Result<T>> post(String endpoint, Object request, Class<T> responseType) {
        return restTemplate.postForEntity(
            getBaseUrl() + endpoint,
            request,
            new ParameterizedTypeReference<Result<T>>() {}
        );
    }
    
    protected <T> ResponseEntity<Result<T>> get(String endpoint, Class<T> responseType) {
        return restTemplate.exchange(
            getBaseUrl() + endpoint,
            HttpMethod.GET,
            null,
            new ParameterizedTypeReference<Result<T>>() {}
        );
    }
}
```

#### 2.4.2 API测试用例
```java
// UserApiTest.java
class UserApiTest extends ApiTestBase {
    
    private static String authToken;
    private static Long testUserId;
    
    @Test
    @Order(1)
    @DisplayName("用户注册API测试")
    void testUserRegister() {
        UserRegisterRequest request = new UserRegisterRequest();
        request.setUsername("testuser_" + System.currentTimeMillis());
        request.setPassword("password123");
        request.setRealName("测试用户");
        request.setEmail("test@example.com");
        
        ResponseEntity<Result<User>> response = post("/auth/register", request, User.class);
        
        assertEquals(HttpStatus.OK, response.getStatusCode());
        assertTrue(response.getBody().isSuccess());
        assertNotNull(response.getBody().getData());
        
        testUserId = response.getBody().getData().getId();
    }
    
    @Test
    @Order(2)
    @DisplayName("用户登录API测试")
    void testUserLogin() {
        UserLoginRequest request = new UserLoginRequest();
        request.setUsername("testuser");
        request.setPassword("password123");
        
        ResponseEntity<Result<String>> response = post("/auth/login", request, String.class);
        
        assertEquals(HttpStatus.OK, response.getStatusCode());
        assertTrue(response.getBody().isSuccess());
        assertNotNull(response.getBody().getData());
        
        authToken = response.getBody().getData();
    }
    
    @Test
    @Order(3)
    @DisplayName("获取用户信息API测试")
    void testGetUserInfo() {
        HttpHeaders headers = new HttpHeaders();
        headers.setBearerAuth(authToken);
        HttpEntity<?> entity = new HttpEntity<>(headers);
        
        ResponseEntity<Result<User>> response = restTemplate.exchange(
            getBaseUrl() + "/users/profile",
            HttpMethod.GET,
            entity,
            new ParameterizedTypeReference<Result<User>>() {}
        );
        
        assertEquals(HttpStatus.OK, response.getStatusCode());
        assertTrue(response.getBody().isSuccess());
        assertNotNull(response.getBody().getData());
    }
}
```

## 3. 前端自动化测试

### 3.1 单元测试配置

#### 3.1.1 Jest配置
```javascript
// jest.config.js
module.exports = {
  preset: 'ts-jest',
  testEnvironment: 'jsdom',
  setupFilesAfterEnv: ['<rootDir>/src/tests/setup.ts'],
  moduleNameMapping: {
    '^@/(.*)$': '<rootDir>/src/$1',
    '\\.(css|less|scss|sass)$': 'identity-obj-proxy'
  },
  collectCoverageFrom: [
    'src/**/*.{ts,tsx}',
    '!src/**/*.d.ts',
    '!src/tests/**/*'
  ],
  coverageThreshold: {
    global: {
      branches: 80,
      functions: 80,
      lines: 80,
      statements: 80
    }
  }
};
```

#### 3.1.2 测试环境设置
```typescript
// src/tests/setup.ts
import '@testing-library/jest-dom';
import { configure } from '@testing-library/react';

configure({ testIdAttribute: 'data-testid' });

// Mock IntersectionObserver
global.IntersectionObserver = class IntersectionObserver {
  constructor() {}
  disconnect() {}
  observe() {}
  unobserve() {}
};

// Mock ResizeObserver
global.ResizeObserver = class ResizeObserver {
  constructor() {}
  disconnect() {}
  observe() {}
  unobserve() {}
};

// Mock window.matchMedia
Object.defineProperty(window, 'matchMedia', {
  writable: true,
  value: jest.fn().mockImplementation(query => ({
    matches: false,
    media: query,
    onchange: null,
    addListener: jest.fn(),
    removeListener: jest.fn(),
    addEventListener: jest.fn(),
    removeEventListener: jest.fn(),
    dispatchEvent: jest.fn(),
  })),
});
```

### 3.2 组件单元测试

#### 3.2.1 基础组件测试
```typescript
// Button.test.tsx
import React from 'react';
import { render, screen, fireEvent } from '@testing-library/react';
import { Button } from '@/components/Button';

describe('Button Component', () => {
  test('renders button with text', () => {
    render(<Button>Click me</Button>);
    
    const button = screen.getByRole('button', { name: /click me/i });
    expect(button).toBeInTheDocument();
  });
  
  test('handles click events', () => {
    const handleClick = jest.fn();
    render(<Button onClick={handleClick}>Click me</Button>);
    
    const button = screen.getByRole('button', { name: /click me/i });
    fireEvent.click(button);
    
    expect(handleClick).toHaveBeenCalledTimes(1);
  });
  
  test('applies correct styles based on variant', () => {
    render(<Button variant="primary">Primary Button</Button>);
    
    const button = screen.getByRole('button', { name: /primary button/i });
    expect(button).toHaveClass('btn-primary');
  });
  
  test('is disabled when disabled prop is true', () => {
    render(<Button disabled>Disabled Button</Button>);
    
    const button = screen.getByRole('button', { name: /disabled button/i });
    expect(button).toBeDisabled();
  });
});
```

#### 3.2.2 表单组件测试
```typescript
// LoginForm.test.tsx
import React from 'react';
import { render, screen, fireEvent, waitFor } from '@testing-library/react';
import userEvent from '@testing-library/user-event';
import { LoginForm } from '@/components/LoginForm';
import { Provider } from 'react-redux';
import { configureStore } from '@reduxjs/toolkit';

const mockStore = configureStore({
  reducer: {
    auth: () => ({ isAuthenticated: false, user: null, loading: false })
  }
});

const renderWithProvider = (component: React.ReactElement) => {
  return render(
    <Provider store={mockStore}>
      {component}
    </Provider>
  );
};

describe('LoginForm Component', () => {
  test('renders form fields correctly', () => {
    renderWithProvider(<LoginForm />);
    
    expect(screen.getByLabelText(/用户名/i)).toBeInTheDocument();
    expect(screen.getByLabelText(/密码/i)).toBeInTheDocument();
    expect(screen.getByRole('button', { name: /登录/i })).toBeInTheDocument();
  });
  
  test('shows validation errors for empty fields', async () => {
    const user = userEvent.setup();
    renderWithProvider(<LoginForm />);
    
    const submitButton = screen.getByRole('button', { name: /登录/i });
    await user.click(submitButton);
    
    await waitFor(() => {
      expect(screen.getByText(/请输入用户名/i)).toBeInTheDocument();
      expect(screen.getByText(/请输入密码/i)).toBeInTheDocument();
    });
  });
  
  test('submits form with valid data', async () => {
    const user = userEvent.setup();
    const mockSubmit = jest.fn();
    
    renderWithProvider(<LoginForm onSubmit={mockSubmit} />);
    
    const usernameInput = screen.getByLabelText(/用户名/i);
    const passwordInput = screen.getByLabelText(/密码/i);
    const submitButton = screen.getByRole('button', { name: /登录/i });
    
    await user.type(usernameInput, 'testuser');
    await user.type(passwordInput, 'password123');
    await user.click(submitButton);
    
    await waitFor(() => {
      expect(mockSubmit).toHaveBeenCalledWith({
        username: 'testuser',
        password: 'password123'
      });
    });
  });
});
```

### 3.3 集成测试

#### 3.3.1 Redux状态管理测试
```typescript
// authSlice.test.ts
import { configureStore } from '@reduxjs/toolkit';
import authSlice, { login, logout, updateUser } from '@/store/slices/authSlice';

describe('Auth Slice', () => {
  let store: ReturnType<typeof configureStore>;
  
  beforeEach(() => {
    store = configureStore({
      reducer: {
        auth: authSlice
      }
    });
  });
  
  test('should handle initial state', () => {
    const state = store.getState().auth;
    expect(state.isAuthenticated).toBe(false);
    expect(state.user).toBeNull();
    expect(state.loading).toBe(false);
  });
  
  test('should handle login pending', () => {
    store.dispatch(login.pending('', { username: 'test', password: 'pass' }));
    
    const state = store.getState().auth;
    expect(state.loading).toBe(true);
    expect(state.error).toBeNull();
  });
  
  test('should handle login fulfilled', () => {
    const mockUser = { id: 1, username: 'test', realName: 'Test User' };
    const mockToken = 'mock-jwt-token';
    
    store.dispatch(login.fulfilled(
      { user: mockUser, token: mockToken },
      '',
      { username: 'test', password: 'pass' }
    ));
    
    const state = store.getState().auth;
    expect(state.isAuthenticated).toBe(true);
    expect(state.user).toEqual(mockUser);
    expect(state.token).toBe(mockToken);
    expect(state.loading).toBe(false);
  });
  
  test('should handle login rejected', () => {
    const errorMessage = 'Invalid credentials';
    
    store.dispatch(login.rejected(
      new Error(errorMessage),
      '',
      { username: 'test', password: 'wrong' }
    ));
    
    const state = store.getState().auth;
    expect(state.isAuthenticated).toBe(false);
    expect(state.user).toBeNull();
    expect(state.loading).toBe(false);
    expect(state.error).toBe(errorMessage);
  });
});
```

#### 3.3.2 API服务测试
```typescript
// apiService.test.ts
import { rest } from 'msw';
import { setupServer } from 'msw/node';
import { apiService } from '@/services/api';

const server = setupServer(
  rest.get('/api/users', (req, res, ctx) => {
    return res(
      ctx.status(200),
      ctx.json({
        code: 200,
        message: 'Success',
        data: [
          { id: 1, username: 'user1', realName: 'User 1' },
          { id: 2, username: 'user2', realName: 'User 2' }
        ]
      })
    );
  }),
  
  rest.post('/api/auth/login', (req, res, ctx) => {
    return res(
      ctx.status(200),
      ctx.json({
        code: 200,
        message: 'Login successful',
        data: {
          user: { id: 1, username: 'testuser', realName: 'Test User' },
          token: 'mock-jwt-token'
        }
      })
    );
  })
);

beforeAll(() => server.listen());
afterEach(() => server.resetHandlers());
afterAll(() => server.close());

describe('API Service', () => {
  test('should fetch users successfully', async () => {
    const response = await apiService.getUsers();
    
    expect(response.code).toBe(200);
    expect(response.data).toHaveLength(2);
    expect(response.data[0].username).toBe('user1');
  });
  
  test('should login successfully', async () => {
    const loginData = { username: 'testuser', password: 'password123' };
    const response = await apiService.login(loginData);
    
    expect(response.code).toBe(200);
    expect(response.data.user.username).toBe('testuser');
    expect(response.data.token).toBe('mock-jwt-token');
  });
  
  test('should handle API errors', async () => {
    server.use(
      rest.get('/api/users', (req, res, ctx) => {
        return res(
          ctx.status(500),
          ctx.json({
            code: 500,
            message: 'Internal Server Error',
            data: null
          })
        );
      })
    );
    
    await expect(apiService.getUsers()).rejects.toThrow();
  });
});
```

### 3.4 端到端测试

#### 3.4.1 Cypress配置
```javascript
// cypress.config.js
const { defineConfig } = require('cypress');

module.exports = defineConfig({
  e2e: {
    baseUrl: 'http://localhost:3000',
    supportFile: 'cypress/support/e2e.js',
    specPattern: 'cypress/e2e/**/*.cy.{js,jsx,ts,tsx}',
    video: true,
    screenshotOnRunFailure: true,
    viewportWidth: 1280,
    viewportHeight: 720,
    defaultCommandTimeout: 10000,
    requestTimeout: 10000,
    responseTimeout: 10000,
    env: {
      apiUrl: 'http://localhost:8080/api'
    }
  }
});
```

#### 3.4.2 E2E测试用例
```typescript
// cypress/e2e/login.cy.ts
describe('Login Flow', () => {
  beforeEach(() => {
    cy.visit('/login');
  });
  
  it('should display login form', () => {
    cy.get('[data-testid="login-form"]').should('be.visible');
    cy.get('[data-testid="username-input"]').should('be.visible');
    cy.get('[data-testid="password-input"]').should('be.visible');
    cy.get('[data-testid="login-button"]').should('be.visible');
  });
  
  it('should show validation errors for empty fields', () => {
    cy.get('[data-testid="login-button"]').click();
    
    cy.get('[data-testid="username-error"]')
      .should('be.visible')
      .and('contain', '请输入用户名');
    cy.get('[data-testid="password-error"]')
      .should('be.visible')
      .and('contain', '请输入密码');
  });
  
  it('should login successfully with valid credentials', () => {
    cy.intercept('POST', '/api/auth/login', {
      statusCode: 200,
      body: {
        code: 200,
        message: 'Login successful',
        data: {
          user: { id: 1, username: 'testuser', realName: 'Test User' },
          token: 'mock-jwt-token'
        }
      }
    }).as('loginRequest');
    
    cy.get('[data-testid="username-input"]').type('testuser');
    cy.get('[data-testid="password-input"]').type('password123');
    cy.get('[data-testid="login-button"]').click();
    
    cy.wait('@loginRequest');
    cy.url().should('include', '/dashboard');
    cy.get('[data-testid="user-menu"]').should('contain', 'Test User');
  });
  
  it('should show error message for invalid credentials', () => {
    cy.intercept('POST', '/api/auth/login', {
      statusCode: 401,
      body: {
        code: 401,
        message: '用户名或密码错误',
        data: null
      }
    }).as('loginError');
    
    cy.get('[data-testid="username-input"]').type('wronguser');
    cy.get('[data-testid="password-input"]').type('wrongpass');
    cy.get('[data-testid="login-button"]').click();
    
    cy.wait('@loginError');
    cy.get('[data-testid="error-message"]')
      .should('be.visible')
      .and('contain', '用户名或密码错误');
  });
});
```

```typescript
// cypress/e2e/case-management.cy.ts
describe('Case Management', () => {
  beforeEach(() => {
    cy.login('testuser', 'password123');
    cy.visit('/cases');
  });
  
  it('should display case list', () => {
    cy.intercept('GET', '/api/cases', {
      statusCode: 200,
      body: {
        code: 200,
        data: {
          records: [
            {
              id: 1,
              caseNumber: 'FA202401010001',
              title: '测试案例1',
              productName: '测试产品A',
              status: 'PENDING',
              createTime: '2024-01-01T10:00:00'
            }
          ],
          total: 1,
          size: 10,
          current: 1
        }
      }
    }).as('getCases');
    
    cy.wait('@getCases');
    cy.get('[data-testid="case-table"]').should('be.visible');
    cy.get('[data-testid="case-row"]').should('have.length', 1);
    cy.get('[data-testid="case-number"]').should('contain', 'FA202401010001');
  });
  
  it('should create new case', () => {
    cy.intercept('POST', '/api/cases', {
      statusCode: 200,
      body: {
        code: 200,
        data: {
          id: 2,
          caseNumber: 'FA202401010002',
          title: '新案例',
          status: 'PENDING'
        }
      }
    }).as('createCase');
    
    cy.get('[data-testid="create-case-button"]').click();
    cy.get('[data-testid="case-form"]').should('be.visible');
    
    cy.get('[data-testid="title-input"]').type('新案例');
    cy.get('[data-testid="description-input"]').type('这是一个新创建的案例');
    cy.get('[data-testid="product-name-input"]').type('测试产品B');
    
    cy.get('[data-testid="submit-button"]').click();
    
    cy.wait('@createCase');
    cy.get('[data-testid="success-message"]')
      .should('be.visible')
      .and('contain', '案例创建成功');
  });
  
  it('should filter cases by status', () => {
    cy.intercept('GET', '/api/cases?status=PROCESSING', {
      statusCode: 200,
      body: {
        code: 200,
        data: {
          records: [
            {
              id: 3,
              caseNumber: 'FA202401010003',
              title: '处理中案例',
              status: 'PROCESSING'
            }
          ],
          total: 1
        }
      }
    }).as('filterCases');
    
    cy.get('[data-testid="status-filter"]').select('PROCESSING');
    cy.wait('@filterCases');
    
    cy.get('[data-testid="case-row"]').should('have.length', 1);
    cy.get('[data-testid="case-status"]').should('contain', '处理中');
  });
});
```

## 4. 性能自动化测试

### 4.1 JMeter测试计划

#### 4.1.1 API性能测试
```xml
<!-- API_Performance_Test.jmx -->
<?xml version="1.0" encoding="UTF-8"?>
<jmeterTestPlan version="1.2">
  <hashTree>
    <TestPlan guiclass="TestPlanGui" testclass="TestPlan" testname="SmartFA API Performance Test">
      <elementProp name="TestPlan.arguments" elementType="Arguments">
        <collectionProp name="Arguments.arguments">
          <elementProp name="BASE_URL" elementType="Argument">
            <stringProp name="Argument.name">BASE_URL</stringProp>
            <stringProp name="Argument.value">http://localhost:8080/api</stringProp>
          </elementProp>
        </collectionProp>
      </elementProp>
    </TestPlan>
    
    <!-- 线程组 -->
    <ThreadGroup guiclass="ThreadGroupGui" testclass="ThreadGroup" testname="API Load Test">
      <stringProp name="ThreadGroup.num_threads">100</stringProp>
      <stringProp name="ThreadGroup.ramp_time">10</stringProp>
      <stringProp name="ThreadGroup.duration">60</stringProp>
      <boolProp name="ThreadGroup.scheduler">true</boolProp>
    </ThreadGroup>
    
    <!-- HTTP请求默认值 -->
    <ConfigTestElement guiclass="HttpDefaultsGui" testclass="ConfigTestElement" testname="HTTP Request Defaults">
      <elementProp name="HTTPsampler.Arguments" elementType="Arguments">
        <collectionProp name="Arguments.arguments"/>
      </elementProp>
      <stringProp name="HTTPSampler.domain">${BASE_URL}</stringProp>
      <stringProp name="HTTPSampler.port">8080</stringProp>
      <stringProp name="HTTPSampler.protocol">http</stringProp>
    </ConfigTestElement>
    
    <!-- 登录请求 -->
    <HTTPSamplerProxy guiclass="HttpTestSampleGui" testclass="HTTPSamplerProxy" testname="Login">
      <elementProp name="HTTPsampler.Arguments" elementType="Arguments">
        <collectionProp name="Arguments.arguments">
          <elementProp name="" elementType="HTTPArgument">
            <boolProp name="HTTPArgument.always_encode">true</boolProp>
            <stringProp name="Argument.value">{"username":"testuser","password":"password123"}</stringProp>
            <stringProp name="Argument.metadata">=</stringProp>
          </elementProp>
        </collectionProp>
      </elementProp>
      <stringProp name="HTTPSampler.path">/auth/login</stringProp>
      <stringProp name="HTTPSampler.method">POST</stringProp>
      <boolProp name="HTTPSampler.postBodyRaw">true</boolProp>
    </HTTPSamplerProxy>
    
    <!-- 获取案例列表 -->
    <HTTPSamplerProxy guiclass="HttpTestSampleGui" testclass="HTTPSamplerProxy" testname="Get Cases">
      <stringProp name="HTTPSampler.path">/cases</stringProp>
      <stringProp name="HTTPSampler.method">GET</stringProp>
    </HTTPSamplerProxy>
    
    <!-- 响应断言 -->
    <ResponseAssertion guiclass="AssertionGui" testclass="ResponseAssertion" testname="Response Assertion">
      <collectionProp name="Asserion.test_strings">
        <stringProp name="49586">200</stringProp>
      </collectionProp>
      <stringProp name="Assertion.custom_message"></stringProp>
      <stringProp name="Assertion.test_field">Assertion.response_code</stringProp>
      <boolProp name="Assertion.assume_success">false</boolProp>
      <intProp name="Assertion.test_type">1</intProp>
    </ResponseAssertion>
    
    <!-- 监听器 -->
    <ResultCollector guiclass="ViewResultsFullVisualizer" testclass="ResultCollector" testname="View Results Tree"/>
    <ResultCollector guiclass="SummaryReport" testclass="ResultCollector" testname="Summary Report"/>
  </hashTree>
</jmeterTestPlan>
```

### 4.2 Artillery配置

#### 4.2.1 负载测试配置
```yaml
# artillery-config.yml
config:
  target: 'http://localhost:8080'
  phases:
    - duration: 60
      arrivalRate: 10
      name: "Warm up"
    - duration: 120
      arrivalRate: 50
      name: "Load test"
    - duration: 60
      arrivalRate: 100
      name: "Stress test"
  
  processor: "./test-processor.js"
  
scenarios:
  - name: "User Login and Case Management"
    weight: 70
    flow:
      - post:
          url: "/api/auth/login"
          json:
            username: "testuser"
            password: "password123"
          capture:
            - json: "$.data.token"
              as: "authToken"
      
      - get:
          url: "/api/cases"
          headers:
            Authorization: "Bearer {{ authToken }}"
      
      - post:
          url: "/api/cases"
          headers:
            Authorization: "Bearer {{ authToken }}"
          json:
            title: "Performance Test Case"
            description: "This is a performance test case"
            productName: "Test Product"
  
  - name: "File Upload and Analysis"
    weight: 30
    flow:
      - post:
          url: "/api/auth/login"
          json:
            username: "testuser"
            password: "password123"
          capture:
            - json: "$.data.token"
              as: "authToken"
      
      - post:
          url: "/api/files/upload"
          headers:
            Authorization: "Bearer {{ authToken }}"
          formData:
            file:
              type: "file"
              path: "./test-files/test-image.jpg"
```

## 5. 持续集成配置

### 5.1 GitHub Actions配置

#### 5.1.1 测试流水线
```yaml
# .github/workflows/test.yml
name: Test Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  backend-tests:
    runs-on: ubuntu-latest
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: password
          MYSQL_DATABASE: smartfa_test
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3
      
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd="redis-cli ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'
    
    - name: Cache Maven dependencies
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
    
    - name: Run backend tests
      run: |
        cd backend
        mvn clean test
        mvn jacoco:report
    
    - name: Upload backend test results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: backend-test-results
        path: |
          backend/**/target/surefire-reports/
          backend/**/target/site/jacoco/
    
    - name: SonarCloud Scan
      uses: SonarSource/sonarcloud-github-action@master
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  frontend-tests:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
    
    - name: Install dependencies
      run: |
        cd frontend
        npm ci
    
    - name: Run unit tests
      run: |
        cd frontend
        npm run test:coverage
    
    - name: Run E2E tests
      run: |
        cd frontend
        npm run build
        npm run start:test &
        sleep 30
        npm run test:e2e:ci
    
    - name: Upload frontend test results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: frontend-test-results
        path: |
          frontend/coverage/
          frontend/cypress/videos/
          frontend/cypress/screenshots/

  ai-services-tests:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: ${{ runner.os }}-pip-
    
    - name: Install dependencies
      run: |
        cd ai-services
        pip install -r requirements.txt
        pip install pytest pytest-cov
    
    - name: Run AI services tests
      run: |
        cd ai-services
        pytest --cov=. --cov-report=xml
    
    - name: Upload AI services test results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: ai-services-test-results
        path: ai-services/coverage.xml

  performance-tests:
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests]
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
    
    - name: Install Artillery
      run: npm install -g artillery
    
    - name: Run performance tests
      run: |
        artillery run tests/performance/artillery-config.yml
    
    - name: Upload performance test results
      uses: actions/upload-artifact@v3
      with:
        name: performance-test-results
        path: artillery-report.html

  security-tests:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Run security scan
      uses: securecodewarrior/github-action-add-sarif@v1
      with:
        sarif-file: 'security-scan-results.sarif'
    
    - name: OWASP ZAP Baseline Scan
      uses: zaproxy/action-baseline@v0.7.0
      with:
        target: 'http://localhost:8080'
```

### 5.2 测试报告生成

#### 5.2.1 Allure报告配置
```xml
<!-- backend/pom.xml -->
<plugin>
    <groupId>org.apache.maven.plugins</groupId>
    <artifactId>maven-surefire-plugin</artifactId>
    <version>3.1.2</version>
    <configuration>
        <includes>
            <include>**/*Test.java</include>
        </includes>
        <systemPropertyVariables>
            <allure.results.directory>${project.build.directory}/allure-results</allure.results.directory>
        </systemPropertyVariables>
    </configuration>
</plugin>

<plugin>
    <groupId>io.qameta.allure</groupId>
    <artifactId>allure-maven</artifactId>
    <version>2.12.0</version>
    <configuration>
        <reportVersion>2.19.0</reportVersion>
    </configuration>
</plugin>
```

#### 5.2.2 测试报告聚合脚本
```bash
#!/bin/bash
# scripts/generate-test-report.sh

set -e

echo "Generating comprehensive test report..."

# 创建报告目录
mkdir -p reports
cd reports

# 生成后端测试报告
echo "Generating backend test report..."
cd ../backend
mvn allure:report
cp -r target/site/allure-report ../reports/backend

# 生成前端测试报告
echo "Generating frontend test report..."
cd ../frontend
npm run test:coverage
cp -r coverage ../reports/frontend

# 生成AI服务测试报告
echo "Generating AI services test report..."
cd ../ai-services
pytest --html=../reports/ai-services/test-report.html --self-contained-html

# 生成性能测试报告
echo "Generating performance test report..."
cd ..
artillery report --output reports/performance/report.html tests/performance/artillery-report.json

# 生成综合报告
echo "Generating summary report..."
python scripts/generate-summary-report.py

echo "Test report generation completed!"
echo "Open reports/index.html to view the complete report"
```

## 6. 测试数据管理

### 6.1 测试数据生成器

#### 6.1.1 Java测试数据生成器
```java
// TestDataGenerator.java
@Component
public class TestDataGenerator {
    
    @Autowired
    private UserMapper userMapper;
    
    @Autowired
    private FailureCaseMapper caseMapper;
    
    public void generateTestData() {
        generateUsers();
        generateFailureCases();
        generateFiles();
    }
    
    private void generateUsers() {
        List<User> users = new ArrayList<>();
        
        // 生成测试用户
        for (int i = 1; i <= 10; i++) {
            User user = new User();
            user.setUsername("testuser" + i);
            user.setPassword(PasswordUtil.encode("password123"));
            user.setRealName("测试用户" + i);
            user.setEmail("testuser" + i + "@example.com");
            user.setPhone("1380013800" + i);
            user.setRole(i == 1 ? "ADMIN" : "FA_ENGINEER");
            user.setStatus(1);
            user.setCreateTime(LocalDateTime.now());
            user.setUpdateTime(LocalDateTime.now());
            
            users.add(user);
        }
        
        users.forEach(userMapper::insert);
    }
    
    private void generateFailureCases() {
        List<FailureCase> cases = new ArrayList<>();
        String[] products = {"产品A", "产品B", "产品C"};
        String[] failureModes = {"疲劳失效", "腐蚀失效", "磨损失效", "断裂失效"};
        String[] statuses = {"PENDING", "PROCESSING", "COMPLETED"};
        
        Random random = new Random();
        
        for (int i = 1; i <= 50; i++) {
            FailureCase failureCase = new FailureCase();
            failureCase.setCaseNumber("FA" + LocalDate.now().format(DateTimeFormatter.BASIC_ISO_DATE) + String.format("%04d", i));
            failureCase.setTitle("测试案例" + i);
            failureCase.setDescription("这是第" + i + "个测试案例的描述");
            failureCase.setProductName(products[random.nextInt(products.length)]);
            failureCase.setProductModel("MODEL-" + String.format("%03d", random.nextInt(100)));
            failureCase.setFailureDate(LocalDate.now().minusDays(random.nextInt(30)));
            failureCase.setFailureLocation("位置" + random.nextInt(10));
            failureCase.setFailureMode(failureModes[random.nextInt(failureModes.length)]);
            failureCase.setFailureMechanism("机制" + random.nextInt(5));
            failureCase.setSeverityLevel(new String[]{"低", "中", "高", "紧急"}[random.nextInt(4)]);
            failureCase.setStatus(statuses[random.nextInt(statuses.length)]);
            failureCase.setCreatorId((long) (random.nextInt(10) + 1));
            failureCase.setAssigneeId((long) (random.nextInt(10) + 1));
            failureCase.setCreateTime(LocalDateTime.now().minusHours(random.nextInt(24)));
            failureCase.setUpdateTime(LocalDateTime.now());
            
            cases.add(failureCase);
        }
        
        cases.forEach(caseMapper::insert);
    }
}
```

### 6.2 测试数据清理

#### 6.2.1 数据清理脚本
```sql
-- scripts/cleanup-test-data.sql

-- 清理测试数据（保留系统数据）
DELETE FROM failure_cases WHERE title LIKE '测试案例%';
DELETE FROM users WHERE username LIKE 'testuser%';
DELETE FROM files WHERE filename LIKE 'test%';
DELETE FROM tasks WHERE name LIKE '测试任务%';
DELETE FROM agents WHERE name LIKE '测试智能体%';

-- 重置自增ID
ALTER TABLE failure_cases AUTO_INCREMENT = 1;
ALTER TABLE users AUTO_INCREMENT = 1;
ALTER TABLE files AUTO_INCREMENT = 1;
ALTER TABLE tasks AUTO_INCREMENT = 1;
ALTER TABLE agents AUTO_INCREMENT = 1;
```

## 7. 最佳实践

### 7.1 测试编写原则
1. **FIRST原则**：Fast（快速）、Independent（独立）、Repeatable（可重复）、Self-Validating（自我验证）、Timely（及时）
2. **AAA模式**：Arrange（准备）、Act（执行）、Assert（断言）
3. **单一职责**：每个测试只验证一个功能点
4. **测试命名**：使用描述性的测试名称
5. **测试隔离**：测试之间不应相互依赖

### 7.2 持续改进
1. **定期评审**：定期评审和优化测试用例
2. **监控指标**：监控测试覆盖率和执行时间
3. **反馈循环**：建立快速反馈机制
4. **知识分享**：分享测试经验和最佳实践
5. **工具升级**：持续关注和引入新的测试工具

### 7.3 团队协作
1. **代码审查**：测试代码也需要审查
2. **文档维护**：保持测试文档的更新
3. **培训学习**：定期组织测试技能培训
4. **责任分工**：明确测试责任和分工
5. **沟通协调**：加强开发和测试的沟通

---

本指南提供了SmartFA项目的完整自动化测试解决方案，涵盖了从单元测试到端到端测试的各个层面。通过遵循这些指南和最佳实践，可以建立高效、可靠的自动化测试体系，确保软件质量和交付效率。